name: Release Build & Package with Meson

on:
  release:
    types: [published] # Este workflow se ejecutará cuando se publique una nueva release (o un nuevo tag asociado a una release)

jobs:
  build:
    name: Build, Package, and Upload for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        # Definimos los sistemas operativos para los que queremos compilar
        os: [ubuntu-latest]
        #, macos-latest, windows-latest]
        # Para releases, es común usar una versión específica y estable de Meson.
        # Quitamos la iteración de versiones para simplificar el artefacto final.
        # Puede ajustar "1.4.0" a la versión de Meson que prefiera.
        meson_version: ["1.4.0"] # Última versión estable al momento de escribir esto

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Meson and Ninja Build
        run: python -m pip install meson==${{ matrix.meson_version }} ninja

      - name: Configure Project
        run: meson setup builddir/ # Configura el proyecto en el directorio 'builddir/'
        # Nota: He eliminado la variable 'CC: gcc' para permitir que Meson detecte
        # el compilador por defecto de cada sistema operativo (ej. MSVC en Windows, GCC/Clang en Linux/macOS).
        # Si necesita un compilador específico (como GCC en Windows), tendría que añadir pasos de instalación para MinGW-w64.

      - name: Compile Project
        run: meson compile -C builddir/ # Compila el proyecto

      - name: Install Project to Staging Directory
        # El comando 'meson install --destdir <path>' instala el proyecto
        # en un directorio temporal, listo para ser empaquetado.
        run: meson install -C builddir/ --destdir ${{ github.workspace }}/output_package/


      - name: Create Zip Archive (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          ZIP_NAME="${{ github.event.repository.name }}-${{ github.event.release.tag_name }}-${{ matrix.os }}-${{ runner.arch }}.zip"
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV
          cd ${{ github.workspace }}/output_package/
          zip -r "../$ZIP_NAME" ./*
          echo "ZIP_FILE_PATH=${{ github.workspace }}/$ZIP_NAME" >> $GITHUB_ENV


      - name: Create Zip Archive (Windows)
        if: runner.os == 'Windows'
        run: |
          $ZIP_NAME = "${{ github.event.repository.name }}-${{ github.event.release.tag_name }}-${{ matrix.os }}-${{ runner.arch }}.zip"
          echo "ZIP_NAME=$ZIP_NAME" | Out-File -FilePath $env:GITHUB_ENV -Append
          Compress-Archive -Path "${{ github.workspace }}\output_package\*" -DestinationPath "${{ github.workspace }}\$ZIP_NAME"
          echo "ZIP_FILE_PATH=${{ github.workspace }}\$ZIP_NAME" | Out-File -FilePath $GITHUB_ENV -Append


      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Token automático para interactuar con la API de GitHub
        with:
          upload_url: ${{ github.event.release.upload_url }} # URL para subir activos a esta release
          asset_path: ${{ env.ZIP_FILE_PATH }} # Ruta al archivo zip que hemos creado
          asset_name: ${{ env.ZIP_NAME }} # Nombre con el que aparecerá el archivo en la release
          asset_content_type: application/zip # Tipo MIME del archivo
          